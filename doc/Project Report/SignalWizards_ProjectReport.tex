\documentclass[letterpaper, 11pt, onecolumn, oneside]{article}

%%%%%%%%%%%%%%%%% Preamble %%%%%%%%%%%%%%%%%
% Packages
\usepackage[utf8]{inputenc}
\usepackage{textcomp}
\usepackage{multirow}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{fancyhdr}
\usepackage{xcolor}
\usepackage[margin=1in]{geometry}
\usepackage[T1]{fontenc}
\usepackage{enumitem}
\usepackage{rotating}
\usepackage{hyperref}
\usepackage{needspace}
\usepackage{appendix}
\usepackage[linesnumbered,lined,boxed]{algorithm2e}

% Variables
\newcommand{\thisassignment}{Graduate Project Report}
\newcommand{\myteam}{Signal Wizards}

\renewcommand{\familydefault}{\rmdefault}

% Styling
\definecolor{msu-maroon}{HTML}{660000}

\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    urlcolor=blue,
}

\setlength{\parindent}{0pt}
\setlength{\parskip}{1em}

\fancypagestyle{header}{
    \renewcommand{\headrulewidth}{2pt}
    \renewcommand{\headrule}{\hbox to\headwidth{\color{msu-maroon}\leaders\hrule height \headrulewidth\hfill}}
    \renewcommand{\footrulewidth}{2pt}
    \renewcommand{\footrule}{\hbox to\headwidth{\color{msu-maroon}\leaders\hrule height \footrulewidth\hfill}}
    \fancyhf{}
    \fancyhead[L]{\scriptsize ECE 6413}
    \fancyhead[C]{\LARGE {Digital Signal Processing}}
    \fancyhead[R]{\scriptsize Eric Farmer (EDF63)\\Will Carroll (WOC17)}
    \fancyfoot[L]{\scriptsize DSP - \thisassignment{}}
    \fancyfoot[C]{\scriptsize Page \thepage}
    \fancyfoot[R]{\scriptsize \today}
}
\pagestyle{header}

% Info
\title{
    Virtual Reconstruction of Spacial Reverberation \\
    \Large{Graduate Project Report}
}
\author{
    \begin{tabular}{cc}
        \multicolumn{2}{c}{\textbf{Team Signal Wizards}}                   \\
                                         &                                 \\
        Eric Farmer                      & Will Carroll                    \\
        \href{mailto:edf63@msstate.edu}{\texttt{edf63@msstate.edu}}       & \href{mailto:woc17@msstate.edu}{\texttt{woc17@msstate.edu}}      \\
        Leader                           & Member
    \end{tabular}
}
\date{December 2, 2018}

% Body
\begin{document}

\maketitle
\newpage

\section{Abstract}
The objective of this project is to create a system that artificially reconstructs the reverberative properties of an environment.
By capturing the impulse response of the designated space, this system allows the user to simulate the space's acoustics for various inputs.
This ability is useful for sound engineers to test audio performance in different environments without the difficulty of a real-world experiment.
Additionally, this system could reduce configuration time for public address (PA) systems by allowing the user to identify anomalies in the space's frequency response.
This application is beyond the scope of this project, but serves as an example of the potential applications of this experiment.
For system performance analysis, the output of the artificial space is compared to the captured output of the real-world space for controlled inputs.

\Needspace{10\baselineskip}
\section{Introduction}
The objective of this project is to design a system to artificially reconstruct the spacial presence of an environment using the environment's impulse response.
This system has applications in virtual reality \cite{beig2018scalable} where realistic acoustic feedback is necessary for improving the user experience.
Additionally, the system could be applied in live audio performances where the audio engineer must consider the frequency response of the environment.
According to Johnson and Lee \cite{johnsonperceptually}, proper reverb is crucial to the improved subjective quality of a sound.
Designing a system to artificially reconstruct an environment requires capturing the impulse response and artificially reconstructing the sound.

    \subsection*{Capturing the Impulse Response of a Space}
    The impulse response of the environment is critical to the process of reconstructing its spacial presence.
    Capturing the impulse response is a two-part process --- generate an acoustical impulse and measure the response of the space.
    An acoustical impulse needs to be a nearly instantaneous burst of sound.
    There are specialized devices to generate an acoustical impulse, but these devices are costly and usually impractical for the identified applications of this system.
    Based on research presented by the Audio Engineering Society \cite{abel2010estimating}, popping a balloon can serve as a replacement for acoustical impulse generation devices in most situations.
    Other research suggested a person clapping his hands in the space to create the impulse.
    The balloon pop method is used in this project because of its low cost and ease of repeating performance, which would be difficult if clapping hands.

    \subsection*{Simulating Audio Responses of a Space}
    Once a spatial impulse response has been captured and recorded, it can be used with a linear convolution to simulate the systemic output of the space.
    In short, the reverberative effects and frequency response of the space can be applied to any arbitrary input signal. Additionally, the impulse response can be transformed into the frequency domain to compute its frequency and phase response.
    The benefit of these effects is twofold. Firstly, the measured impulse response can be used as an audio effect allowing the audio acoustics of the room to be used in musical and vocal effects.
    Secondly, information about the room itself can be leveraged -- the frequency response can be used to pinpoint resonant frequencies in the room.
    This data is useful for tuning audio systems or modifying the room itself to manipulate the frequency response.

\Needspace{10\baselineskip}
\section{Methodology \& Theory}
Using Octave, the spacial presence of five locations is artificially reconstructed.
Each environment has an infinite impulse response (IIR) that defines the reverberation that occurs in the space.
Since this impulse response is infinite in length and cannot be captured by a digital signal processing system, the objective of this experiment is to determine a FIR filter that approximates the impulse response of the IIR filter.
An FIR approximation of each space is obtained by inputting a impulse in the space and recording the output using a microphone.
Because of the sampling rate and duration of sampling, the FIR may become large compared to usual filters.
While a large filter may not be practical for real-time implementation, there are applications in post-processing effects and room analysis that do not require real-time speed.
However, a stretch goal is to minimze the filter size without an appreciative loss in quality, as determined by the qualitative analysis, so that the filters may be used in applications such as live performances or virtual reality simulations.
The experiment is conducted by measuring the room impulse response (RIR), inputting an audio sample into the room while recording the output, and comparing to a synthesized version of the output from Octave.
To provide a variety of reverberation scenarios, the RIR is captured from the following locations:
\begin{itemize}
    \item Eric Farmer's Living room
    \item Simrall Hall Anechoic Chamber
    \item Simrall Hall Stairwell
    \item MSU SSRC Foyer
    \item MSU Old Intramural Fields.
\end{itemize}

The following is an equipment list used for this project:
\begin{itemize}
    \item Balloons: \href{https://www.amazon.com/gp/product/B01LBTKVDY/ref=oh_aui_detailpage_o04_s00?ie=UTF8&psc=1}{Nexci Premium Quality 12in. Helium or Air Balloons}
    \item Microphone: \href{https://dbxpro.com/en/products/rta-m}{dbx RTA-M Reference Microphone}
    \item Speaker: \href{https://www.edifier.com/int/en/speakers/studio-1280t-2.0-powered-bookshelf}{Edifier R1280T Powered Bookshelf Speaker}
    \item Mixer/Preamp: \href{https://assets.peavey.com/literature/manuals/117405_9170.pdf}{Peavey XR\texorpdfstring{\textsuperscript{\textregistered}} 8300 Powered Mixer}
    \item Recording Software: \href{https://www.audacityteam.org/}{Audacity\texorpdfstring{\textsuperscript{\textregistered}} v2.3.0}
    \item Simulation Software: \href{https://www.gnu.org/software/octave/}{GNU Octave v4.2.2}
\end{itemize}

The first step to measuring the RIR is to determine the noise floor of the room and the microphone.
This is accomplished by observing the output of the room when there is no input.
Using identical balloons filled to the same circumference, the balloon pop simulates the impulse input into each space.
To prevent uneven spacial effects, the balloon and microphone are colocated in the center of the space.
An operator pops the balloon above the microphone using a sharp needle while standing an arm's length away.
The microphone records the response of the room.
The operator is not colocated with the microphone and the balloon to prevent distortions in the reverbation.
The microphone records the impulse response until the room returns to a threshold set by the root mean square (RMS) of the noise floor.
This process determines a large FIR filter for the space and is repeated three times for each location.

After measuring the RIR and the space has returned to its noise floor, each audio input sample is played and the output of the room recorded on the microphone.
To prevent spacial distortions, the audio input sample is played through a single speaker colocated under the microphone.
Both the speaker and the microphone are positioned such that the focus of the output/input is upward.
This process is repeated for each location.

After collecting the RIR for each space, Octave is used to convolve each audio input sample with each spacial impulse response.
This provides a set of simulated outputs versus a set of real outputs for each location.
Qualitative and quantitative measurements were obtained comparing the simulated and real outputs, which is discussed in the following section.

The stretch goal is performed by using Octave to decimate the filter and calculating the output for each audio input sample at each location.
The decimation is performed on the set of decimation factors, $D = [2, 4, 8, 16, 32, 64, 128, 256]$.
Due to the amount of samples generated by this process, only the speech samples were qualitatively measured.

\clearpage
\section{Analysis of Results}
After performing the actions described in the Methodology \& Theory section, the results were analyzed quantitatively and qualitatively.

For the quantitative analysis, a mean square error (MSE) was generated to determine the difference between the simulated and the real outputs.
Based on plots of the three impulse responses collected at each of the five locations, the third impulse response was selected for each location to be representative of the set.
This was done to decrease the processing time and increase the code simplicity.
Once the impulse response for each location was selected, the next step was to calculate the MSE between the simulated and real outputs.
This was accomplished using \texttt{calculate\_mse.m} from Appendix~\ref{appendix:resources}, and a pseudocode of the process is shown in Algorithm~\ref{alg:mse}.

\begin{algorithm}[H]
    \caption{Simulated vs. Real Output MSE Calculation}
    \label{alg:mse}
    \DontPrintSemicolon

    \SetKwData{Sim}{sim\_sample} \SetKwData{Real}{real\_sample} \SetKwData{IndxSim}{indx\_sim} \SetKwData{IndxReal}{indx\_real}
    \SetKwFunction{Normalize}{normalize} \SetKwFunction{Immse}{immse} \SetKwFunction{Find}{find} \SetKwFunction{Max}{max} \SetKwFunction{Zeropad}{zeropad}
    \SetKwFunction{Length}{length} \SetKwFunction{Trunc}{truncate}

    \KwIn{Simulated Sample; Real Sample}
    \KwOut{MSE between the two samples}
    \BlankLine
    \ForEach{$loc \leftarrow locations$}{
        \Sim $\leftarrow$ \Normalize{simulated sample at $loc$}\;
        \Real $\leftarrow$ \Normalize{real sample at $loc$}\;
        Apply Butterworth LPF to \Sim \& \Real\;
        \IndxSim $\leftarrow$ \Find{\Sim $>$ \Max{\Sim}}\;
        \IndxReal $\leftarrow$ \Find{\Real $>$ \Max{\Real}}\;
        \If{\IndxSim $<$ \IndxReal}{\Zeropad{\Sim}}
        \Else{\Zeropad{\Real}}
        \If{\Length{\Sim} $<$ \Length{\Real}}{\Trunc{\Real}}
        \Else{\Trunc{\Sim}}
        \Immse{\Sim, \Real}\;
    }
\end{algorithm}

For the qualitative analysis, a test group of five people was selected to listen to the simulated and real outputs and give an opinion on the similarities of the samples.
For the stretch goal, each person listened to the original simulated voice sample and compared it to each decimated voice sample at each location.
The qualitative scale was selected to be the following:
\begin{itemize}
    \item 1 - Nearly identical sounds; minimal distinguishable features
    \item 0.5 - Similar sounds; the simulated version could pass as a replacement for the real version in some situations
    \item 0 - Dissimilar sounds; the simulated version fails as a replacement for the real version
\end{itemize}

The results of the qualitative and quantitative analysis are shown in Figure~\ref{fig:mseResults} and Figure~\ref{fig:decimatedResults}.
The plot in Figure~\ref{fig:mseCorrelation} was designed to determine if a correlation existed between MSE and the qualitative measurements.
From this  plot, it can generally be assumed that an inverse relationship between the MSE and the qualitative measurement exists.
However, due to the number of outlying data points, more research is necessary to determine any more meaningful results.
The plot in Figure~\ref{fig:decimatedCorrelation} shows the correlation between the decimation factor and the qualitative measurements.
From this plot, an increase in the decimation factor resulted in a qualitatively-worse sounding sample.

\begin{figure}[ht]
    \includegraphics[width=0.5\textwidth]{"img/fig_Results"}
    \centering
    \caption{Qualitative \& Quantitative Results for Simulated vs. Real Outputs}
    \label{fig:mseResults}
\end{figure}

\begin{figure}[ht]
    \includegraphics[width=0.5\textwidth]{"img/fig_DecimationResults"}
    \centering
    \caption{Qualitative Results for Decimated Simulated Outputs}
    \label{fig:decimatedResults}
\end{figure}

\begin{figure}[ht]
    \includegraphics[width=0.7\textwidth]{"img/plot_SimulatedVsRealOutput"}
    \centering
    \caption{MSE Correlation to Qualitative Response}
    \label{fig:mseCorrelation}
\end{figure}

\begin{figure}[ht]
    \includegraphics[width=0.7\textwidth]{"img/plot_DecimatedSamplesComparison"}
    \centering
    \caption{Decimation Factor Correlation to Qualitative Response}
    \label{fig:decimatedCorrelation}
\end{figure}

\clearpage
\section{Conclusion}
In conclusion, this project generated acoustical responses of five distinct locations and compared them to the real responses.
Additionally, the simulated responses were generated using a decimated version of the impulse response, and the resulting sample was compared to the original simulated sample.
Overall, this project demonstrated some interesting results about the correlation of the MSE with the quality of the simulated output.
Generally, it was observed that a smaller MSE meant a higher quality simulated output.
But, since the dataset was small and there were a relatively large number of outliers, it is difficult to ascertain what level of MSE is acceptable for a quality simulation.
Further testing to generate more samples is required to determine more correlations.
For the stretch goal, it was found that an increase in the decimation factor resulted in a worse quality simulation.

From the data, there are some inconsistent patterns between the MSE and the simulation quality.
These inconsistencies are most likely due to sources of error in the experiment.
There are two major sources of error identified with this experiment.
First, the speaker and microphone most likely have nonlinearities in their frequency response, especially the speaker.
A nonlinearity in the speaker would generate some differences in the real outputs that would not be observed in the simulated outputs.
Secondly, for the sake of code simplicity, the third impulse response was chosen for each location because it was generally representative of the set.
However, a better method of selection would have been to simulate each input sample with each impulse response at each location and then select the impulse response with the minimum MSE.

Overall, the results of this experiment are a good starting point for attempting to accurately simulate the spacial effects of a space.
Further work could be performed in this area to determine if a correlation exists between MSE and the quality of the simulation, and if there are any other factors that affect the quality.
Additionally, more research into decimating the impulse response without losing quality could be performed so that this system could be better utilized in real-time systems.

\clearpage
\begin{appendix}
\section{Resources}
\label{appendix:resources}
The code and data used in this project is located in the following GitHub repository:

\href{https://github.com/WhoFama24/DSP_VirtualSpacialReconstruction}{DSP\_VirtualSpacialReconstruction}

\section{Location Photos}
\label{appendix:locationPhotos}
\begin{figure}[h!t]
    \includegraphics[width=0.8\textwidth]{"../Location Photos/SignalWizards_AnechoicChamber"}
    \centering
    \caption{Location 1: Anechoic Chamber}
\end{figure}

\begin{figure}[h!t]
    \includegraphics[width=0.8\textwidth]{"../Location Photos/SignalWizards_LivingRoom"}
    \centering
    \caption{Location 2: Eric Farmer's Living Room}
\end{figure}

\begin{figure}[h!t]
    \includegraphics[width=0.8\textwidth]{"../Location Photos/SignalWizards_OldIntramuralField"}
    \centering
    \caption{Location 3: MSU Old Intramural Field}
\end{figure}

\begin{figure}[h!t]
    \includegraphics[width=0.8\textwidth]{"../Location Photos/SignalWizards_SimrallStairwell"}
    \centering
    \caption{Location 4: Simrall Stairwell}
\end{figure}

\begin{figure}[h!t]
    \includegraphics[width=0.8\textwidth]{"../Location Photos/SignalWizards_SSRCFoyer"}
    \centering
    \caption{Location 5: MSU SSRC Foyer}
\end{figure}
\end{appendix}

\clearpage
\bibliography{SignalWizards_ProjectReport}
\bibliographystyle{ieeetr}

\end{document}
